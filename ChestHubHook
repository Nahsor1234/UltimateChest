-- // ULTIMATE CHEST HUB V2 (CONFIG + WEBHOOK + FINAL) //

-- // [1] USER CONFIGURATION //
getgenv().UserConfig = {
    -- Discord Webhook (Your URL)
    WebhookURL = "https://discord.com/api/webhooks/1462804066781364359/Xh5J3nE6FyQ1g3y4abuX6YZYfTzrBS5gW1SxEqytxqybE-jokz0uPlMgfa5NVM8Ej22t",
    
    -- Farming Settings
    TweenSpeed = 350,       -- Flight Speed (Lower = Faster)
    CollectionWait = 0.35,  -- Time to wait at each chest
    HopDelay = 5,           -- Seconds to wait before hopping
    
    -- Toggles
    AFKMode = true,         -- Start with Black Screen (Battery Saver)
    FastMode = true,        -- Remove textures/shadows (FPS Boost)
    FarmChests = true,      -- Enable Chest Farming
    FarmFruit = true,       -- Enable Fruit Sniping
    StopOnRareItem = true   -- Stop if God's Chalice/Fist is found
}

-- // [2] SERVICES //
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local Lighting = game:GetService("Lighting")
local VirtualUser = game:GetService("VirtualUser")
local CoreGui = game:GetService("CoreGui")

local Player = Players.LocalPlayer or Players.PlayerAdded:Wait()

-- // [3] LOAD SETTINGS //
local UserSettings = getgenv().UserConfig
local Config = {
    WebhookURL = UserSettings.WebhookURL,
    TweenSpeed = UserSettings.TweenSpeed,
    CollectionWait = UserSettings.CollectionWait,
    AFKMode = UserSettings.AFKMode,
    FastMode = UserSettings.FastMode,
    StopOnRareItem = UserSettings.StopOnRareItem,
    FarmChests = UserSettings.FarmChests,
    FarmFruit = UserSettings.FarmFruit,
    HopDelay = UserSettings.HopDelay,
    
    -- Internal Constants
    MinGroupRank = 2,            
    AdminGroupID = 4372130,      
    CircleRadius = 600,          
    IslandBlacklistRadius = 600, 
    MaxFarmDistance = 4000       
}

-- // [4] VARIABLES //
local Stats = { Chests = 0, ZonesDone = 0 }
local VisitedChests = {} 
local FinishedIslandPositions = {} 
local Farming = true 
local IsMoving = false 
local StartTime = os.time()
local StartMoney = 0
local StartPosition = nil
local ChestRetryCounter = 0 
local RareItems = {"God's Chalice", "Fist of Darkness"}
local IsAFK = Config.AFKMode 
local PlaceID = game.PlaceId
local AllIDs = {}
local foundAnything = ""
local actualHour = os.date("!*t").hour
local Hopping = false 

-- // [5] HOP FILE SETUP //
local function SetupHopFile()
    pcall(function()
        if not isfile("NotSameServers.json") then
            writefile("NotSameServers.json", HttpService:JSONEncode({actualHour}))
        else
            AllIDs = HttpService:JSONDecode(readfile("NotSameServers.json"))
            if tonumber(AllIDs[1]) ~= actualHour then
                 AllIDs = {actualHour}
                 writefile("NotSameServers.json", HttpService:JSONEncode(AllIDs))
            end
        end
    end)
end
SetupHopFile()

pcall(function() StartMoney = Player.Data.Beli.Value end)
pcall(function() ReplicatedStorage.Remotes.CommF_:InvokeServer("SetTeam", "Pirates") end)

-- // [6] WEBHOOK FUNCTION //
local function SendWebhook(fruitName)
    task.spawn(function()
        local request = http_request or request or HttpPost or syn.request
        if not request then return end

        local currentBeli = 0
        pcall(function() currentBeli = Player.Data.Beli.Value end)
        local earned = currentBeli - StartMoney
        if earned < 0 then earned = 0 end
        
        -- Calculate Time
        local duration = os.time() - StartTime
        local timeString = string.format("%02d:%02d:%02d", math.floor(duration/3600), math.floor((duration%3600)/60), duration%60)

        -- Format Description
        local desc = ""
        desc = desc .. "**Player:** " .. Player.Name .. "\n"
        desc = desc .. "**Time:** " .. timeString .. "\n"
        desc = desc .. "**Chests:** " .. tostring(Stats.Chests) .. "\n"
        desc = desc .. "**Money:** $" .. tostring(earned) .. "\n"
        desc = desc .. "**Total.Money:** $" .. tostring(currentBeli) .. "\n"
        desc = desc .. "**Fruit:** " .. (fruitName or "None")

        local data = {
            ["embeds"] = {{
                ["title"] = fruitName ~= "None" and "ðŸŽ FRUIT SNIPED!" or "ðŸ’° SERVER HOP REPORT",
                ["description"] = desc, 
                ["color"] = fruitName ~= "None" and 16711680 or 65280
            }}
        }
        
        pcall(function()
            request({
                Url = Config.WebhookURL, 
                Body = HttpService:JSONEncode(data), 
                Method = "POST", 
                Headers = {["Content-Type"] = "application/json"}
            })
        end)
    end)
end

-- // [7] ANTI-IDLE //
Player.Idled:Connect(function()
    VirtualUser:Button2Down(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
    task.wait(1)
    VirtualUser:Button2Up(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
end)

-- // [8] AUTO REJOIN //
task.spawn(function()
    if CoreGui:FindFirstChild("RobloxPromptGui") then
        CoreGui.RobloxPromptGui.promptOverlay.ChildAdded:Connect(function(child)
            if child.Name == 'ErrorPrompt' then
                task.wait(2)
                TeleportService:Teleport(game.PlaceId, Player)
            end
        end)
    end
end)

-- // [9] UI SETUP //
pcall(function()
    if Player:FindFirstChild("PlayerGui") then
        for _, v in pairs(Player.PlayerGui:GetChildren()) do if v.Name == "ChestHub_Core" then v:Destroy() end end
    end
end)

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "ChestHub_Core"
ScreenGui.IgnoreGuiInset = true 
ScreenGui.Parent = Player:WaitForChild("PlayerGui") 

-- AFK OVERLAY
local BlurFrame = Instance.new("Frame")
BlurFrame.Name = "AFKOverlay"
BlurFrame.Parent = ScreenGui
BlurFrame.Size = UDim2.new(1, 0, 1, 0)
BlurFrame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
BlurFrame.BackgroundTransparency = Config.AFKMode and 0 or 1 
Blur
