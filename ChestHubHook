-- // NAHSOR CHESTHUB (UI LAYOUT FIXED) //

-- // [1] SERVICES //
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local Lighting = game:GetService("Lighting")
local VirtualUser = game:GetService("VirtualUser")
local CoreGui = game:GetService("CoreGui")

local Player = Players.LocalPlayer or Players.PlayerAdded:Wait()

-- // [2] CONFIGURATION //
local Config = {
    WebhookURL = "",
    TweenSpeed = 350,       
    CollectionWait = 0.1, 
    AFKMode = true,
    FastMode = true,
    StopOnRareItem = true,
    AdminHop = true, 
    FarmChests = true,
    FarmFruit = true,
    HopDelay = 5,
    MaxFarmDistance = 4000
}

-- [LOADER SUPPORT]
pcall(function()
    if getgenv().UserConfig then
        local user = getgenv().UserConfig
        if user.TweenSpeed then Config.TweenSpeed = user.TweenSpeed end
        if user.AFKMode ~= nil then Config.AFKMode = user.AFKMode end
        if user.FastMode ~= nil then Config.FastMode = user.FastMode end
        if user.StopOnRareItem ~= nil then Config.StopOnRareItem = user.StopOnRareItem end
        if user.FarmChests ~= nil then Config.FarmChests = user.FarmChests end
    end
end)

-- // [3] VARIABLES //
local Stats = { Chests = 0 }
local VisitedChests = {} 
local CollectedPositions = {} 
local Farming = true 
local IsMoving = false 
local StartTime = os.time()
local StartMoney = 0
local StartPosition = nil
local ChestRetryCounter = 0 
local RareItems = {"God's Chalice", "Fist of Darkness"} 
local IsAFK = Config.AFKMode 
local PlaceID = game.PlaceId
local AllIDs = {}
local foundAnything = ""
local Hopping = false 

-- // [4] FILE SYSTEM //
local function SetupHopFile()
    pcall(function()
        local currentHour = os.date("!*t").hour
        if not isfile("NotSameServers.json") then
            writefile("NotSameServers.json", HttpService:JSONEncode({currentHour}))
        else
            AllIDs = HttpService:JSONDecode(readfile("NotSameServers.json"))
            if tonumber(AllIDs[1]) ~= currentHour then
                 AllIDs = {currentHour}
                 writefile("NotSameServers.json", HttpService:JSONEncode(AllIDs))
            end
        end
    end)
end
SetupHopFile()

task.spawn(function()
    pcall(function() StartMoney = Player.Data.Beli.Value end)
    pcall(function() ReplicatedStorage.Remotes.CommF_:InvokeServer("SetTeam", "Pirates") end)
end)

-- // [5] WEBHOOK //
local function SendWebhook(fruitName)
    if Config.WebhookURL == "" then return end
    task.spawn(function()
        local request = http_request or request or HttpPost or syn.request
        if not request then return end

        local currentBeli = 0
        pcall(function() currentBeli = Player.Data.Beli.Value end)
        local earned = currentBeli - StartMoney
        
        local duration = os.time() - StartTime
        local timeString = string.format("%02d:%02d:%02d", math.floor(duration/3600), math.floor((duration%3600)/60), duration%60)

        local title = fruitName ~= "None" and "ðŸŽ FRUIT SNIPED!" or "ðŸ’° SERVER HOP REPORT"
        local color = fruitName ~= "None" and 16711680 or 65280

        local data = {
            ["embeds"] = {{
                ["title"] = title,
                ["description"] = "**Chests:** " .. Stats.Chests .. "\n**Earned:** $" .. earned .. "\n**Item:** " .. (fruitName or "None"), 
                ["color"] = color
            }}
        }
        
        pcall(function()
            request({
                Url = Config.WebhookURL, 
                Body = HttpService:JSONEncode(data), 
                Method = "POST", 
                Headers = {["Content-Type"] = "application/json"}
            })
        end)
    end)
end

-- // [6] UI SETUP //
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "ChestHub_Core"
ScreenGui.IgnoreGuiInset = true 
pcall(function() 
    if Player.PlayerGui:FindFirstChild("ChestHub_Core") then Player.PlayerGui.ChestHub_Core:Destroy() end
    ScreenGui.Parent = Player.PlayerGui 
end)

local BlurFrame = Instance.new("Frame")
BlurFrame.Name = "AFKOverlay"
BlurFrame.Parent = ScreenGui
BlurFrame.Size = UDim2.new(1, 0, 1, 0)
BlurFrame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
BlurFrame.BackgroundTransparency = Config.AFKMode and 0 or 1 
BlurFrame.Visible = Config.AFKMode 

local MainFrame = Instance.new("Frame")
MainFrame.Name = "StatsFrame"
MainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
MainFrame.Position = UDim2.new(0.02, 0, 0.4, 0)
MainFrame.Size = UDim2.new(0, 160, 0, 0) 
MainFrame.AutomaticSize = Enum.AutomaticSize.Y
MainFrame.Parent = ScreenGui
MainFrame.Active = true       
MainFrame.Draggable = true    

local UIStroke = Instance.new("UIStroke")
UIStroke.Parent = MainFrame
UIStroke.Color = Color3.fromRGB(255, 60, 60)
UIStroke.Thickness = 1
local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 6)
UICorner.Parent = MainFrame

local UIListLayout = Instance.new("UIListLayout")
UIListLayout.Parent = MainFrame
-- [FIX] THIS LINE WAS MISSING! IT FORCES BUTTONS TO BOTTOM
UIListLayout.SortOrder = Enum.SortOrder.LayoutOrder 
UIListLayout.Padding = UDim.new(0, 2) 

local UIPadding = Instance.new("UIPadding")
UIPadding.Parent = MainFrame
UIPadding.PaddingTop = UDim.new(0, 8)
UIPadding.PaddingLeft = UDim.new(0, 8)
UIPadding.PaddingRight = UDim.new(0, 8)
UIPadding.PaddingBottom = UDim.new(0, 8)

local function createLabel(text, order, color)
    local Label = Instance.new("TextLabel")
    Label.Parent = MainFrame
    Label.BackgroundTransparency = 1
    Label.Size = UDim2.new(1, 0, 0, 14) 
    Label.Font = Enum.Font.GothamBold
    Label.Text = text
    Label.TextColor3 = color or Color3.fromRGB(255, 255, 255)
    Label.TextSize = 11 
    Label.TextXAlignment = Enum.TextXAlignment.Left
    Label.LayoutOrder = order
    return Label
end

local TitleLbl = createLabel("NAHSOR CHESTHUB", 0, Color3.fromRGB(255, 60, 60))
local ChestsLbl = createLabel("Chests: 0", 1, Color3.fromRGB(255, 170, 0))
local FruitLbl = createLabel("Fruit: None", 2, Color3.fromRGB(255, 85, 255))
local TimerLbl = createLabel("Timer: 00:00:00", 3, Color3.fromRGB(200, 200, 200))
local EarnedLbl = createLabel("Earned: $0", 5, Color3.fromRGB(85, 255, 127))
local StatusLbl = createLabel("Status: Active", 6, Color3.fromRGB(255, 255, 255))

-- [FIX] SPACER RESTORED
local Spacer = Instance.new("Frame")
Spacer.BackgroundTransparency = 1
Spacer.Size = UDim2.new(1, 0, 0, 4)
Spacer.LayoutOrder = 7
Spacer.Parent = MainFrame

local BtnRow1 = Instance.new("Frame")
BtnRow1.BackgroundTransparency = 1
BtnRow1.Size = UDim2.new(1, 0, 0, 20)
BtnRow1.LayoutOrder = 8
BtnRow1.Parent = MainFrame

local ToggleBtn = Instance.new("TextButton")
ToggleBtn.Parent = BtnRow1
ToggleBtn.Text = "ON"
ToggleBtn.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
ToggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleBtn.Size = UDim2.new(0.48, 0, 1, 0)
ToggleBtn.Font = Enum.Font.GothamBlack
ToggleBtn.TextSize = 10
Instance.new("UICorner", ToggleBtn).CornerRadius = UDim.new(0, 4)

local HopBtn = Instance.new("TextButton")
HopBtn.Parent = BtnRow1
HopBtn.Text = "HOP"
HopBtn.BackgroundColor3 = Color3.fromRGB(45, 120, 255)
HopBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
HopBtn.Position = UDim2.new(0.52, 0, 0, 0)
HopBtn.Size = UDim2.new(0.48, 0, 1, 0)
HopBtn.Font = Enum.Font.GothamBlack
HopBtn.TextSize = 10
Instance.new("UICorner", HopBtn).CornerRadius = UDim.new(0, 4)

local BtnRow2 = Instance.new("Frame")
BtnRow2.BackgroundTransparency = 1
BtnRow2.Size = UDim2.new(1, 0, 0, 20)
BtnRow2.LayoutOrder = 10
BtnRow2.Parent = MainFrame

local AFKBtn = Instance.new("TextButton")
AFKBtn.Parent = BtnRow2
AFKBtn.Text = Config.AFKMode and "AFK: ON" or "AFK: OFF"
AFKBtn.BackgroundColor3 = Config.AFKMode and Color3.fromRGB(100, 255, 100) or Color3.fromRGB(60, 60, 60)
AFKBtn.TextColor3 = Config.AFKMode and Color3.fromRGB(0, 0, 0) or Color3.fromRGB(255, 255, 255)
AFKBtn.Size = UDim2.new(1, 0, 1, 0)
AFKBtn.Font = Enum.Font.GothamBlack
AFKBtn.TextSize = 10
Instance.new("UICorner", AFKBtn).CornerRadius = UDim.new(0, 4)

-- // [7] FAST MODE //
local function ApplyFastMode()
    if not Config.FastMode then return end
    pcall(function()
        Lighting.GlobalShadows = false
        Lighting.FogEnd = 9e9
        for _, v in pairs(Workspace:GetDescendants()) do
            if v:IsA("BasePart") then v.Material = Enum.Material.SmoothPlastic v.CastShadow = false end
            if v:IsA("Texture") or v:IsA("Decal") then v.Transparency = 1 end
        end
    end)
end
task.spawn(function() while task.wait(5) do ApplyFastMode() end end)

-- // [8] SERVER HOP //
local function ServerHop()
    if Hopping then return end
    Hopping = true
    SendWebhook("None") 
    StatusLbl.Text = "Finding New Server..."
    
    task.wait(Config.HopDelay)
    
    local pageAttempts = 0
    local function FetchAndHop()
        SetupHopFile()
        pageAttempts = pageAttempts + 1
        if pageAttempts > 5 then
            delfile("NotSameServers.json")
            AllIDs = {os.date("!*t").hour}
            pageAttempts = 0
        end

        local url = 'https://games.roblox.com/v1/games/' .. PlaceID .. '/servers/Public?sortOrder=Asc&limit=100'
        if foundAnything ~= "" then url = url .. "&cursor=" .. foundAnything end
        
        local success, Site = pcall(function() return HttpService:JSONDecode(game:HttpGet(url)) end)
        if not success or not Site or not Site.data then 
            task.wait(2)
            FetchAndHop() 
            return
        end

        if Site.nextPageCursor and Site.nextPageCursor ~= "null" then foundAnything = Site.nextPageCursor else foundAnything = "" end
        
        for i=1, 15 do
            local v = Site.data[math.random(1, #Site.data)]
            if v and v.id and tonumber(v.playing) < tonumber(v.maxPlayers) and v.id ~= game.JobId then
                local Visited = false
                for _, id in pairs(AllIDs) do if id == v.id then Visited = true end end
                if not Visited then
                    table.insert(AllIDs, v.id)
                    pcall(function() writefile("NotSameServers.json", HttpService:JSONEncode(AllIDs)) end)
                    TeleportService:TeleportToPlaceInstance(PlaceID, v.id, Player)
                    return
                end
            end
        end
        task.wait(0.2)
        FetchAndHop()
    end
    pcall(FetchAndHop)
end

-- // [9] ADMIN HOP WATCHDOG //
task.spawn(function()
    TeleportService.TeleportInitFailed:Connect(function(player, result, message)
        if player == Player then
            StatusLbl.Text = "TP FAILED: RETRYING..."
            Hopping = false 
            task.wait(2)
            ServerHop()
        end
    end)
    
    Players.PlayerAdded:Connect(function(v)
        if Config.AdminHop then
            local success, rank = pcall(function() return v:GetRankInGroup(4372130) end)
            if success and rank and rank > 0 then 
                StatusLbl.Text = "STAFF DETECTED! HOPPING..."
                Hopping = false
                ServerHop()
            end
        end
    end)

    while true do
        task.wait(3) 
        pcall(function()
            local prompt = CoreGui:FindFirstChild("RobloxPromptGui")
            if prompt and prompt:FindFirstChild("promptOverlay") then
                local errorPopup = prompt.promptOverlay:FindFirstChild("ErrorPrompt")
                if errorPopup and errorPopup.Visible then
                    StatusLbl.Text = "ERROR! HOPPING..."
                    Hopping = false 
                    task.wait(1)
                    ServerHop() 
                end
            end
        end)
    end
end)

local function StoreFruit(fruitInstance)
    if not fruitInstance then return end
    local char = Player.Character
    local cleanName = fruitInstance.Name:gsub(" Fruit", "")
    StatusLbl.Text = "Store: " .. cleanName
    
    if fruitInstance.Parent == Player.Backpack then fruitInstance.Parent = char task.wait(0.5) end
    SendWebhook(cleanName)
    
    local args = { [1] = "StoreFruit", [2] = fruitInstance:GetAttribute("OriginalName") or fruitInstance.Name, [3] = fruitInstance }
    pcall(function() ReplicatedStorage.Remotes.CommF_:InvokeServer("StoreFruit", args[2], args[3]) end)
    if fruitInstance.Parent == char then
        pcall(function() ReplicatedStorage.Remotes.CommF_:InvokeServer("StoreFruit", cleanName, fruitInstance) end)
    end
    task.wait(0.5)
    StatusLbl.Text = "Status: Active"
end

-- // [10] FARM LOOP //
local function FarmLoop()
    if not Farming or IsMoving or Hopping then return end
    local root = Player.Character:FindFirstChild("HumanoidRootPart")
    if not root then return end
    if not StartPosition then StartPosition = root.Position end

    -- RARE ITEM STOP
    if Config.StopOnRareItem then
        for _, item in pairs(RareItems) do
            if Player.Backpack:FindFirstChild(item) or Player.Character:FindFirstChild(item) then
                 Farming = false
                 StatusLbl.Text = "FOUND: " .. item
                 local s = Instance.new("Sound", workspace)
                 s.SoundId = "rbxassetid://4590657391"
                 s:Play()
                 return
            end
        end
    end

    -- FRUIT SNIPER
    if Config.FarmFruit then
        for _, v in pairs(Workspace:GetChildren()) do
            if v:IsA("Tool") and v.Name:find("Fruit") and v:FindFirstChild("Handle") then
                StatusLbl.Text = "Sniping..."
                FruitLbl.Text = "Fruit: " .. v.Name
                root.CFrame = v.Handle.CFrame 
                if v.Handle:FindFirstChild("TouchInterest") then
                    firetouchinterest(root, v.Handle, 0)
                    firetouchinterest(root, v.Handle, 1)
                end
                task.wait(0.1) 
                local picked = Player.Backpack:FindFirstChild(v.Name) or Player.Character:FindFirstChild(v.Name)
                if picked then StoreFruit(picked) end
                return 
            end
        end
    end

    -- CHEST FARMING
    local target, minDist = nil, math.huge
    if Config.FarmChests then
        for _, v in pairs(Workspace:GetDescendants()) do
            if (v.Name:find("Chest") or v.Name:find("Box")) and v:IsA("Part") then
                local distFromStart = (v.Position - StartPosition).Magnitude
                
                local isDuplicate = false
                for _, pos in pairs(CollectedPositions) do
                    if (v.Position - pos).Magnitude < 4 then
                        isDuplicate = true
                        break 
                    end
                end

                if distFromStart < Config.MaxFarmDistance and not VisitedChests[v] and not isDuplicate then
                    local d = (root.Position - v.Position).Magnitude
                    if d < minDist then target, minDist = v, d end
                end
            end
        end
    end

    if target then
        ChestRetryCounter = 0 
        local dist = math.floor((root.Position - target.Position).Magnitude)
        StatusLbl.Text = "Travel: " .. dist .. "m"
        IsMoving = true
        
        local tween = TweenService:Create(root, TweenInfo.new(dist/Config.TweenSpeed, Enum.EasingStyle.Linear), {CFrame = target.CFrame})
        tween:Play()
        
        while tween.PlaybackState == Enum.PlaybackState.Playing do
            if not Farming then 
                tween:Cancel() 
                IsMoving = false 
                StatusLbl.Text = "PAUSED"
                return 
            end
            if root and target then
                local currentDist = math.floor((root.Position - target.Position).Magnitude)
                StatusLbl.Text = "Flying: " .. currentDist .. "m"
            end
            task.wait()
        end
        
        IsMoving = false
        StatusLbl.Text = "Collecting..."
        
        if target:IsDescendantOf(Workspace) then
            VisitedChests[target] = true 
            root.CFrame = target.CFrame 
            
            firetouchinterest(root, target, 0)
            firetouchinterest(root, target, 1)
            
            task.wait(Config.CollectionWait)
            
            Stats.Chests = Stats.Chests + 1
            ChestsLbl.Text = "Chests: " .. Stats.Chests 
            
            table.insert(CollectedPositions, target.Position)
        end
    else
        ChestRetryCounter = ChestRetryCounter + 1
        StatusLbl.Text = "Scan: " .. ChestRetryCounter .. "/20"
        
        if ChestRetryCounter >= 20 then ServerHop() end
    end
end

-- // [11] EVENTS //
ToggleBtn.MouseButton1Click:Connect(function()
    Farming = not Farming
    ToggleBtn.Text = Farming and "ON" or "OFF"
    ToggleBtn.BackgroundColor3 = Farming and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(200, 50, 50)
    if Farming then 
        StartPosition = Player.Character.HumanoidRootPart.Position 
    else
        IsMoving = false
        StatusLbl.Text = "STOPPED"
    end
end)
HopBtn.MouseButton1Click:Connect(ServerHop)
AFKBtn.MouseButton1Click:Connect(function()
    IsAFK = not IsAFK
    AFKBtn.Text = IsAFK and "AFK: ON" or "AFK: OFF"
    AFKBtn.BackgroundColor3 = IsAFK and Color3.fromRGB(100, 255, 100) or Color3.fromRGB(60, 60, 60)
    AFKBtn.TextColor3 = IsAFK and Color3.fromRGB(0, 0, 0) or Color3.fromRGB(255, 255, 255)
    BlurFrame.Visible = IsAFK
    BlurFrame.BackgroundTransparency = IsAFK and 0 or 1
end)
Player.Idled:Connect(function() VirtualUser:Button2Down(Vector2.new(0,0),workspace.CurrentCamera.CFrame) task.wait(1) VirtualUser:Button2Up(Vector2.new(0,0),workspace.CurrentCamera.CFrame) end)

task.spawn(function()
    while true do
        local secs = os.time() - StartTime
        TimerLbl.Text = string.format("Timer: %02d:%02d:%02d", math.floor(secs/3600), math.floor((secs%3600)/60), secs%60)
        if Player.Data and Player.Data.Beli then EarnedLbl.Text = "Earned: $" .. (Player.Data.Beli.Value - StartMoney) end
        task.wait(1)
    end
end)

task.spawn(function() while true do if Farming then pcall(FarmLoop) end task.wait() end end)
