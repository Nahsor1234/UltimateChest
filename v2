-- // NAHSOR CHESTHUB V7.0 (ULTIMATE STABILITY & PERFORMANCE) //

-- // [1] LOCAL VARIABLE CACHING (Optimization 25) //
local game, workspace = game, workspace
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")
local CoreGui = game:GetService("CoreGui")
local VirtualUser = game:GetService("VirtualUser")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local task_wait, task_spawn = task.wait, task.spawn
local math_floor, math_huge = math.floor, math.huge
local os_time, os_date = os.time, os.date
local string_find = string.find
local Vector3_new, Vector2_new = Vector3.new, Vector2.new
local CFrame_new = CFrame.new

local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")

-- // [2] CONFIGURATION //
local Config = {
    WebhookURL = "https://discord.com/api/webhooks/1462804066781364359/Xh5J3nE6FyQ1g3y4abuX6YZYfTzrBS5gW1SxEqytxqybE-jokz0uPlMgfa5NVM8Ej22t",
    TweenSpeed = 350,       
    CollectionWait = 0.5, 
    AFKMode = true,
    FastMode = true,
    StopOnRareItem = true,
    AdminHop = true, 
    FarmChests = true,
    FarmFruit = true,
    HopDelay = 5,
    MaxFarmDistance = 4000,
    MaxFarmDistanceSq = 4000^2, -- Optimization 10: Pre-calculate squared distance
    CacheRefreshRate = 5,       -- Performance 6: Refresh cache every 5s
    StuckThreshold = 15,        -- Stability 12: Stuck detection time
    MinPlayers = 3              -- Stability 11: Auto-hop if server dying
}

-- Loader Sync (Optimization 24)
pcall(function()
    if getgenv().UserConfig then
        for k, v in pairs(getgenv().UserConfig) do Config[k] = v end
        Config.MaxFarmDistanceSq = Config.MaxFarmDistance^2 -- Recalculate if user changed distance
    end
end)

-- // [3] VARIABLES & CACHING //
local Stats = { Chests = 0, StartMoney = 0, StartTime = os_time() }
local ChestCache = {}       -- Performance 6: Chest Cache
local VisitedChests = {} 
local CollectedPositions = {} 
local Farming, IsMoving, Hopping = true, false, false
local LastMoveTime = os_time()
local LastPos = Vector3_new()
local LastCacheRefresh = 0
local LastDataSave = os_time() -- Stability 13
local RareItems = {"God's Chalice", "Fist of Darkness"}

-- // [4] UTILITY FUNCTIONS //

-- Anti-AFK (Critical 1)
Player.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2_new())
end)

-- Robust File System (Stability 15)
local function SafeFileAction(name, data)
    local success, result = pcall(function()
        if data then 
            writefile(name, HttpService:JSONEncode(data))
            return true
        else 
            return HttpService:JSONDecode(readfile(name)) 
        end
    end)
    return success and result
end

-- Server Health & Hop (Stability 11)
local function ServerHop()
    if Hopping then return end
    Hopping = true
    
    -- Save blacklist logic
    local AllIDs = SafeFileAction("NotSameServers.json") or {os_date("!*t").hour}
    if not table.find(AllIDs, game.JobId) then
        table.insert(AllIDs, game.JobId)
    end
    SafeFileAction("NotSameServers.json", AllIDs)

    -- Optimization 8: Combined pcall
    local function Fetch()
        local url = 'https://games.roblox.com/v1/games/'..game.PlaceId..'/servers/Public?sortOrder=Asc&limit=100'
        local s, res = pcall(function() return HttpService:JSONDecode(game:HttpGet(url)) end)
        
        if s and res and res.data then
            for _, v in pairs(res.data) do
                if v.playing < v.maxPlayers and v.id ~= game.JobId and not table.find(AllIDs, v.id) then
                    TeleportService:TeleportToPlaceInstance(game.PlaceId, v.id, Player)
                    return
                end
            end
        end
        task_wait(1) Fetch()
    end
    Fetch()
end

-- Webhook (Updated Logic)
local function SendWebhook(item)
    if Config.WebhookURL == "" then return end
    task_spawn(function()
        local currentMoney = 0
        pcall(function() currentMoney = Player.Data.Beli.Value end)
        local earned = currentMoney - Stats.StartMoney
        local duration = os_time() - Stats.StartTime
        
        local embed = {
            ["title"] = item and "ðŸš¨ RARE ITEM FOUND!" or "ðŸ’° SERVER REPORT",
            ["description"] = string_format(
                "**Chests:** %d\n**Earned:** $%d\n**Time:** %02d:%02d:%02d\n**Item:** %s",
                Stats.Chests, earned, math_floor(duration/3600), math_floor((duration%3600)/60), duration%60, item or "None"
            ),
            ["color"] = item and 16711680 or 65280
        }
        
        request({
            Url = Config.WebhookURL,
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = HttpService:JSONEncode({embeds = {embed}})
        })
    end)
end

-- // [5] UI SYSTEM //
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "NahsorChestHub"
pcall(function() ScreenGui.Parent = PlayerGui end)

local MainFrame = Instance.new("Frame", ScreenGui)
MainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
MainFrame.Position = UDim2.new(0.02, 0, 0.4, 0)
MainFrame.Size = UDim2.new(0, 160, 0, 0)
MainFrame.AutomaticSize = Enum.AutomaticSize.Y

local UIList = Instance.new("UIListLayout", MainFrame)
UIList.SortOrder = Enum.SortOrder.LayoutOrder
UIList.Padding = UDim.new(0, 2)
Instance.new("UIPadding", MainFrame).PaddingLeft = UDim.new(0, 10)

local function Label(text, color, order)
    local l = Instance.new("TextLabel", MainFrame)
    l.Text = text
    l.TextColor3 = color or Color3.new(1,1,1)
    l.BackgroundTransparency = 1
    l.Size = UDim2.new(1,0,0,15)
    l.Font = Enum.Font.GothamBold
    l.TextSize = 12
    l.TextXAlignment = Enum.TextXAlignment.Left
    l.LayoutOrder = order
    return l
end

local LblTitle = Label("NAHSOR CHESTHUB V7", Color3.fromRGB(255, 60, 60), 0)
local LblChests = Label("Chests: 0", Color3.fromRGB(255, 170, 0), 1)
local LblEarned = Label("Earned: $0", Color3.fromRGB(85, 255, 127), 2)
local LblStatus = Label("Status: Active", Color3.new(1,1,1), 3)

local BtnToggle = Instance.new("TextButton", MainFrame)
BtnToggle.Text = "TOGGLE"
BtnToggle.Size = UDim2.new(1,-20,0,20)
BtnToggle.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
BtnToggle.LayoutOrder = 4

-- // [6] CORE LOGIC & CACHING //

-- Performance 6 & 7: Smart Caching
local function UpdateCache()
    if os_time() - LastCacheRefresh < Config.CacheRefreshRate then return end
    LastCacheRefresh = os_time()
    
    table.clear(ChestCache)
    -- Performance 7: Cache GetDescendants results
    for _, v in pairs(workspace:GetDescendants()) do
        if (string_find(v.Name, "Chest") or string_find(v.Name, "Box")) and v:IsA("Part") then
            table.insert(ChestCache, v)
        end
    end
end

-- Stability 12: Anti-Stuck Logic
local function CheckStuck(root)
    if (root.Position - LastPos).Magnitude < 2 then
        if os_time() - LastMoveTime > Config.StuckThreshold then
            LblStatus.Text = "Stuck! Hopping..."
            ServerHop()
        end
    else
        LastMoveTime = os_time()
        LastPos = root.Position
    end
end

-- Critical 2: Death Handler
Player.CharacterAdded:Connect(function(char)
    Farming = false
    task_wait(1)
    Farming = true
end)

-- Main Farm Function
local function Farm()
    -- Critical 3: Global Error Wrapper
    local success, err = pcall(function()
        if not Farming or Hopping then return end
        
        -- Optimization 25: Local variable caching
        local char = Player.Character
        local root = char and char:FindFirstChild("HumanoidRootPart")
        if not root then return end
        
        -- Stability 12: Stuck Check
        CheckStuck(root)
        
        -- Optimization 21: Timer Throttling
        if os_time() % 2 == 0 then UpdateCache() end
        
        -- Rare Item Check
        if Config.StopOnRareItem then
            for _, item in pairs(RareItems) do
                if Player.Backpack:FindFirstChild(item) or char:FindFirstChild(item) then
                    Farming = false
                    SendWebhook(item)
                    return
                end
            end
        end

        -- Find Nearest Chest
        local target, minDistSq = nil, math_huge
        local myPos = root.Position
        
        for _, v in pairs(ChestCache) do
            -- Performance 9: Cache Validation
            if v and v.Parent then
                local distSq = (v.Position - myPos).Magnitude^2 -- Performance 10
                if distSq < Config.MaxFarmDistanceSq and not VisitedChests[v] then
                     -- Check for collected proximity
                    local isDup = false
                    for _, pos in pairs(CollectedPositions) do
                        if (v.Position - pos).Magnitude^2 < 16 then isDup = true break end
                    end
                    
                    if not isDup and distSq < minDistSq then
                        target = v
                        minDistSq = distSq
                    end
                end
            end
        end

        -- Movement Logic
        if target then
            IsMoving = true
            local dist = math.sqrt(minDistSq)
            LblStatus.Text = "Travel: "..math_floor(dist).."m"
            
            local tween = TweenService:Create(root, TweenInfo.new(dist/Config.TweenSpeed, Enum.EasingStyle.Linear), {CFrame = target.CFrame})
            tween:Play()
            
            -- Missing Logic 18: Tween Completion Handler
            local completed = false
            local conn
            conn = tween.Completed:Connect(function()
                completed = true
                conn:Disconnect()
            end)
            
            -- Loop Continuation Wait
            while not completed and Farming and target.Parent do
                task_wait(0.1) -- Critical 5: FPS Limiter
            end
            
            if not Farming then tween:Cancel() return end
            
            -- Missing Logic 16: Collection
            if target.Parent then
                root.CFrame = target.CFrame
                firetouchinterest(root, target, 0)
                firetouchinterest(root, target, 1)
                
                -- Missing Logic 17: Stats Updating
                local oldMoney = Player.Data.Beli.Value
                task_wait(Config.CollectionWait)
                if Player.Data.Beli.Value > oldMoney then
                    Stats.Chests = Stats.Chests + 1
                    VisitedChests[target] = true
                    table.insert(CollectedPositions, target.Position)
                    
                    LblChests.Text = "Chests: "..Stats.Chests
                    LblEarned.Text = "Earned: $"..(Player.Data.Beli.Value - Stats.StartMoney)
                end
            end
            IsMoving = false
        else
            -- Missing Logic 20: Loop Continuation (Search Mode)
            LblStatus.Text = "Scanning..."
            if os_time() - LastMoveTime > 10 then ServerHop() end
        end
    end)
    
    if not success then warn("Farm Error:", err) task_wait(1) end
end

-- // [7] INITIALIZATION //

-- Missing Logic 19: Button Events
BtnToggle.MouseButton1Click:Connect(function()
    Farming = not Farming
    BtnToggle.BackgroundColor3 = Farming and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(200, 50, 50)
    LblStatus.Text = Farming and "Active" or "Stopped"
end)

-- Critical 4: Memory Cleanup (Hourly)
task_spawn(function()
    while task_wait(3600) do
        VisitedChests = {}
        CollectedPositions = {}
    end
end)

-- Stability 11: Server Health Check
task_spawn(function()
    while task_wait(10) do
        if #Players:GetPlayers() < Config.MinPlayers then
            LblStatus.Text = "Low Players! Hopping..."
            ServerHop()
        end
    end
end)

-- Initialize Stats
pcall(function() Stats.StartMoney = Player.Data.Beli.Value end)

-- Start Main Loop
task_spawn(function()
    while true do
        if Farming then Farm() end
        task_wait(0.1) -- Critical 5: Main Loop FPS Limiter
    end
end)

-- Optimization 7: Fast Mode
if Config.FastMode then
    pcall(function()
        Lighting.GlobalShadows = false
        for _,v in pairs(workspace:GetDescendants()) do
            if v:IsA("BasePart") then v.Material = Enum.Material.SmoothPlastic end
        end
    end)
end
