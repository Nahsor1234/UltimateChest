-- // NAHSOR CHESTHUB V19 - CHUNK 1 //
-- [Config System | Floating UI | Save/Load Logic]

if not game:IsLoaded() then game.Loaded:Wait() end

-- [1] SERVICES
local Players = game:GetService("Players")
local LP = Players.LocalPlayer
local HttpService = game:GetService("HttpService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local CoreGui = game:GetService("CoreGui")
local VirtualUser = game:GetService("VirtualUser")
local Lighting = game:GetService("Lighting")

-- [2] CONFIGURATION DEFAULTS
local FileName = "NahsorConfig.json"

-- Define the Default Settings (The "Editor" Values)
getgenv().Config = {
    Disable3DRender = true,     -- Turns screen black to save RAM
    AFKMode = true,             -- Adds black overlay to save battery
    FastMode = true,            -- Lowers texture quality
    UltraFastMode = false,      -- Deletes Map (Void Mode)
    FarmChests = true,          -- Main Feature
    FarmFruit = true,           -- Snipe Fruits
    StopOnRareItem = true,      -- Stop for God's Chalice
    MaxTime = 120,              -- Force hop after X seconds
    TweenSpeed = 350,           -- Flight speed
    MaxFarmDistance = 4000,     -- Scan range
    HopDelay = 8,               -- Wait before hop
    WebhookURL = ""             -- Discord Webhook
}

-- [3] OVERWRITE SYSTEM (Load Saved Settings)
-- If a file exists, we use those values instead of the defaults above.
if isfile(FileName) then 
    pcall(function() 
        local SavedSettings = HttpService:JSONDecode(readfile(FileName)) 
        for Key, Value in pairs(SavedSettings) do 
            if getgenv().Config[Key] ~= nil then 
                getgenv().Config[Key] = Value 
            end
        end 
    end) 
end

-- Save Function (Used by the UI)
local function SaveConfig() 
    pcall(function() 
        writefile(FileName, HttpService:JSONEncode(getgenv().Config)) 
    end) 
end

-- [4] FLOATING CONFIG UI
task.spawn(function()
    local GuiName = "NahsorConfig_UI_V19"
    pcall(function() if LP.PlayerGui:FindFirstChild(GuiName) then LP.PlayerGui[GuiName]:Destroy() end end)
    
    local Gui = Instance.new("ScreenGui")
    Gui.Name = GuiName
    Gui.Parent = LP:WaitForChild("PlayerGui")

    -- UI Helper
    local function Create(class, props)
        local inst = Instance.new(class)
        for k, v in pairs(props) do inst[k] = v end
        return inst
    end

    -- GEAR BUTTON
    local OpenBtn = Create("TextButton", {
        Parent = Gui, Size = UDim2.new(0, 45, 0, 45), Position = UDim2.new(0.05, 0, 0.3, 0),
        BackgroundColor3 = Color3.fromRGB(35, 35, 35), Text = "âš™", TextSize = 24,
        TextColor3 = Color3.fromRGB(255, 255, 255), AutoButtonColor = false
    })
    Create("UICorner", {Parent = OpenBtn, CornerRadius = UDim.new(1, 0)})
    Create("UIStroke", {Parent = OpenBtn, Color = Color3.fromRGB(0, 255, 255), Thickness = 2})

    -- DRAG LOGIC
    local drag, startPos
    OpenBtn.InputBegan:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.Touch or i.UserInputType == Enum.UserInputType.MouseButton1 then
            drag = i.Position; startPos = OpenBtn.Position
            i.Changed:Connect(function() if i.UserInputState == Enum.UserInputState.End then drag = nil end end)
        end
    end)
    UserInputService.InputChanged:Connect(function(i)
        if (i.UserInputType == Enum.UserInputType.Touch or i.UserInputType == Enum.UserInputType.MouseMovement) and drag then
            local d = i.Position - drag
            OpenBtn.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + d.X, startPos.Y.Scale, startPos.Y.Offset + d.Y)
        end
    end)

    -- MAIN FRAME
    local Main = Create("Frame", {
        Parent = Gui, Visible = false, Size = UDim2.new(0, 300, 0, 360),
        Position = UDim2.new(0.5, -150, 0.5, -180), BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    })
    Create("UICorner", {Parent = Main, CornerRadius = UDim.new(0, 8)})
    Create("UIStroke", {Parent = Main, Color = Color3.fromRGB(60, 60, 60), Thickness = 1})

    -- HEADER
    Create("TextLabel", {
        Parent = Main, Size = UDim2.new(1, 0, 0, 35), BackgroundTransparency = 1,
        Text = "  NAHSOR CHESTHUB", TextColor3 = Color3.fromRGB(0, 255, 255),
        TextSize = 14, Font = Enum.Font.GothamBold, TextXAlignment = Enum.TextXAlignment.Left
    })

    -- SCROLL LIST
    local Scroll = Create("ScrollingFrame", {
        Parent = Main, Size = UDim2.new(1, -10, 1, -45), Position = UDim2.new(0, 5, 0, 40),
        BackgroundTransparency = 1, ScrollBarThickness = 3, CanvasSize = UDim2.new(0, 0, 0, 0)
    })
    local List = Create("UIListLayout", {
        Parent = Scroll, Padding = UDim.new(0, 5), SortOrder = Enum.SortOrder.LayoutOrder
    })
    List:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        Scroll.CanvasSize = UDim2.new(0, 0, 0, List.AbsoluteContentSize.Y + 10)
    end)

    -- OPTION GENERATOR
    local function AddOption(name, key, type)
        local Row = Create("Frame", {
            Parent = Scroll, Size = UDim2.new(1, -6, 0, 38), BackgroundColor3 = Color3.fromRGB(35, 35, 35)
        })
        Create("UICorner", {Parent = Row, CornerRadius = UDim.new(0, 6)})

        Create("TextLabel", {
            Parent = Row, Size = UDim2.new(0.6, 0, 1, 0), Position = UDim2.new(0, 10, 0, 0),
            BackgroundTransparency = 1, Text = name, TextColor3 = Color3.fromRGB(220, 220, 220),
            TextSize = 13, Font = Enum.Font.Gotham, TextXAlignment = Enum.TextXAlignment.Left
        })

        if type == "Bool" then
            local Btn = Create("TextButton", {
                Parent = Row, Size = UDim2.new(0, 45, 0, 22), Position = UDim2.new(1, -50, 0, 8)
            })
            Create("UICorner", {Parent = Btn, CornerRadius = UDim.new(0, 4)})
            
            local function Update()
                local val = getgenv().Config[key]
                Btn.Text = val and "ON" or "OFF"
                Btn.BackgroundColor3 = val and Color3.fromRGB(0, 200, 100) or Color3.fromRGB(200, 50, 50)
            end
            
            Btn.MouseButton1Click:Connect(function()
                getgenv().Config[key] = not getgenv().Config[key]
                Update()
                SaveConfig()
            end)
            Update()
        else
            local Box = Create("TextBox", {
                Parent = Row, Size = UDim2.new(0, 50, 0, 22), Position = UDim2.new(1, -55, 0, 8),
                BackgroundColor3 = Color3.fromRGB(20, 20, 20), TextColor3 = Color3.fromRGB(255, 255, 255),
                Text = tostring(getgenv().Config[key]), Font = Enum.Font.Gotham
            })
            Create("UICorner", {Parent = Box, CornerRadius = UDim.new(0, 4)})
            
            Box.FocusLost:Connect(function()
                local n = tonumber(Box.Text)
                if n then
                    getgenv().Config[key] = n
                    SaveConfig()
                else
                    Box.Text = tostring(getgenv().Config[key])
                end
            end)
        end
    end

    -- POPULATE
    AddOption("Farm Chests", "FarmChests", "Bool")
    AddOption("3D Saver", "Disable3DRender", "Bool")
    AddOption("AFK Mode", "AFKMode", "Bool")
    AddOption("Fast Mode", "FastMode", "Bool")
    AddOption("Ultra Fast", "UltraFastMode", "Bool")
    AddOption("Stop on Rare", "StopOnRareItem", "Bool")
    AddOption("Time Limit", "MaxTime", "Num")
    AddOption("Tween Speed", "TweenSpeed", "Num")
    AddOption("Max Dist", "MaxFarmDistance", "Num")
    AddOption("Hop Delay", "HopDelay", "Num")

    OpenBtn.MouseButton1Click:Connect(function() Main.Visible = not Main.Visible end)
end)








-- // NAHSOR CHESTHUB V19 - CHUNK 2 //
-- [Optimization Functions | Variables | Anti-AFK]

-- [1] GLOBAL VARIABLES
getgenv().Stats = { Chests = 0, StartMoney = 0, StartTime = os.time() }
getgenv().ChestCache = {}
getgenv().VisitedChests = {} 
getgenv().CollectedPositions = {}
getgenv().CollectedFruits = {} 
getgenv().Farming = true
getgenv().Hopping = false
getgenv().IsMoving = false
getgenv().LastMoveTime = os.time()
getgenv().LastPos = Vector3.new(0,0,0)
getgenv().RareItems = {"God's Chalice", "Fist of Darkness"}
getgenv().LastCacheRefresh = 0

-- Capture Start Money
pcall(function() getgenv().Stats.StartMoney = LP.Data.Beli.Value end)

-- [2] AUTO TEAM SELECT
task.spawn(function()
    repeat task.wait() until ReplicatedStorage:FindFirstChild("Remotes") and ReplicatedStorage.Remotes:FindFirstChild("CommF_")
    local attempts = 0
    while attempts < 60 do 
        if LP.Team and LP.Team.Name == "Pirates" then break end
        pcall(function() ReplicatedStorage.Remotes.CommF_:InvokeServer("SetTeam", "Pirates") end)
        attempts = attempts + 1
        task.wait(1)
    end
end)

-- [3] ANTI-AFK
LP.Idled:Connect(function()
    pcall(function() 
        VirtualUser:CaptureController()
        VirtualUser:ClickButton2(Vector2.new(0,0)) 
    end)
end)

-- [4] FAST MODE FUNCTION (Restored)
local function ApplyFastMode()
    if getgenv().Config.UltraFastMode then return end
    if not getgenv().Config.FastMode then return end
    
    Lighting.GlobalShadows = false
    Lighting.FogEnd = 9e9
    settings().Rendering.QualityLevel = Enum.QualityLevel.Level01
    
    for _, v in pairs(workspace:GetDescendants()) do 
        if v:IsA("BasePart") then 
            v.Material = Enum.Material.SmoothPlastic
            v.CastShadow = false 
        end
        if v:IsA("Decal") or v:IsA("Texture") then 
            v.Transparency = 1 
        end
    end
end

-- [5] ULTRA FAST MODE FUNCTION (Restored)
local function ApplyUltraFastMode()
    if not getgenv().Config.UltraFastMode then return end
    
    pcall(function()
        Lighting.GlobalShadows = false
        Lighting.FogEnd = 9e9
        Lighting.Brightness = 0.4
        settings().Rendering.QualityLevel = Enum.QualityLevel.Level01
        
        for _, v in pairs(Lighting:GetChildren()) do 
            if v:IsA("PostEffect") or v:IsA("Sky") then 
                v:Destroy() 
            end 
        end
        
        workspace.Terrain:Clear() -- Void Mode
        
        for _, v in pairs(workspace:GetDescendants()) do 
            if v:IsA("BasePart") then 
                v.Material = Enum.Material.SmoothPlastic
                v.CastShadow = false 
            end
            if v:IsA("Decal") or v:IsA("Texture") or v:IsA("ParticleEmitter") then 
                v:Destroy() 
            end
        end
    end)
end

-- Apply Optimization
task.spawn(function()
    task.wait(1)
    if getgenv().Config.UltraFastMode then 
        ApplyUltraFastMode()
    elseif getgenv().Config.FastMode then 
        ApplyFastMode() 
    end
end)








-- // NAHSOR CHESTHUB V19 - CHUNK 3 //
-- [Status UI | Main Farm | Server Hop]

-- [1] CLASSIC STATUS UI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "ChestHub_Core"
ScreenGui.IgnoreGuiInset = true 
pcall(function() if LP.PlayerGui:FindFirstChild("ChestHub_Core") then LP.PlayerGui.ChestHub_Core:Destroy() end ScreenGui.Parent = LP.PlayerGui end)

local MainFrame = Instance.new("Frame", ScreenGui)
MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
MainFrame.Position = UDim2.new(0.02, 0, 0.4, 0)
MainFrame.Size = UDim2.new(0, 170, 0, 0)
MainFrame.AutomaticSize = Enum.AutomaticSize.Y
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 8)

local Stroke = Instance.new("UIStroke", MainFrame)
Stroke.Color = Color3.fromRGB(200, 40, 40)
Stroke.Thickness = 1.5

local UIList = Instance.new("UIListLayout", MainFrame)
UIList.SortOrder = Enum.SortOrder.LayoutOrder
UIList.Padding = UDim.new(0, 4)

local Padding = Instance.new("UIPadding", MainFrame)
Padding.PaddingTop = UDim.new(0, 10)
Padding.PaddingLeft = UDim.new(0, 10)
Padding.PaddingRight = UDim.new(0, 10)
Padding.PaddingBottom = UDim.new(0, 10)

local function Label(text, color, order)
    local l = Instance.new("TextLabel", MainFrame)
    l.Text = text
    l.TextColor3 = color or Color3.fromRGB(220, 220, 220)
    l.LayoutOrder = order
    l.BackgroundTransparency = 1
    l.Size = UDim2.new(1, 0, 0, 16)
    l.Font = Enum.Font.GothamBold
    l.TextSize = 12
    l.TextXAlignment = Enum.TextXAlignment.Left
    return l
end

TitleLbl = Label("NAHSOR CHESTHUB", Color3.fromRGB(255, 60, 60), 0)
ChestsLbl = Label("Chests: 0", Color3.fromRGB(255, 170, 0), 1)
FruitLbl = Label("Fruit: None", Color3.fromRGB(255, 85, 255), 2)
TimerLbl = Label("Time: 00:00:00", Color3.fromRGB(180, 180, 180), 3)
StatusLbl = Label("Status: Starting...", Color3.fromRGB(255, 255, 255), 5)

-- Render Button (Visual Only)
local ExtraRow = Instance.new("Frame", MainFrame)
ExtraRow.BackgroundTransparency = 1
ExtraRow.Size = UDim2.new(1, 0, 0, 24)
ExtraRow.LayoutOrder = 8
local RenderBtn = Instance.new("TextButton", ExtraRow)
RenderBtn.Size = UDim2.new(1, 0, 1, 0)
Instance.new("UICorner", RenderBtn).CornerRadius = UDim.new(0, 6)

local function UpdateRenderBtn()
    local s = getgenv().Config.Disable3DRender
    RenderBtn.Text = s and "3D: OFF" or "3D: ON"
    RenderBtn.BackgroundColor3 = s and Color3.fromRGB(180, 40, 40) or Color3.fromRGB(40, 180, 40)
    pcall(function() RunService:Set3dRenderingEnabled(not s) end)
end
RenderBtn.MouseButton1Click:Connect(function() 
    getgenv().Config.Disable3DRender = not getgenv().Config.Disable3DRender
    UpdateRenderBtn()
end)
UpdateRenderBtn()

-- [2] HELPER FUNCTIONS
local function StoreFruit(fruit)
    if not fruit or not fruit:FindFirstChild("Handle") then return end
    local fruitName = fruit.Name
    if fruit:GetAttribute("OriginalName") then fruitName = fruit:GetAttribute("OriginalName") end
    table.insert(getgenv().CollectedFruits, fruitName)
    if #getgenv().CollectedFruits > 0 then FruitLbl.Text = "Fruit: " .. table.concat(getgenv().CollectedFruits, ", "); FruitLbl.TextColor3 = Color3.fromRGB(0, 255, 255) end
    local OldCFrame = LP.Character.HumanoidRootPart.CFrame
    LP.Character.HumanoidRootPart.CFrame = fruit.Handle.CFrame
    task.wait(0.2)
    firetouchinterest(LP.Character.HumanoidRootPart, fruit.Handle, 0); firetouchinterest(LP.Character.HumanoidRootPart, fruit.Handle, 1)
    pcall(function() ReplicatedStorage.Remotes.CommF_:InvokeServer("StoreFruit", fruitName, fruit) end)
    task.wait(0.2)
    LP.Character.HumanoidRootPart.CFrame = OldCFrame
end

local function UpdateCache()
    if os.time() - getgenv().LastCacheRefresh < 1.5 then return end
    getgenv().LastCacheRefresh = os.time()
    table.clear(getgenv().ChestCache)
    for _, v in pairs(workspace:GetDescendants()) do
        if (v.Name:find("Chest") or v.Name:find("Box")) and v:IsA("Part") then table.insert(getgenv().ChestCache, v) end
    end
end

local function ServerHop()
    if getgenv().Hopping then return end
    table.clear(getgenv().ChestCache); table.clear(getgenv().VisitedChests); table.clear(getgenv().CollectedPositions)
    for i=1,3 do task.wait(0.1); local _ = gcinfo() end
    
    if getgenv().Config.StopOnRareItem then
        for _, item in pairs(getgenv().RareItems) do if LP.Backpack:FindFirstChild(item) or LP.Character:FindFirstChild(item) then getgenv().Farming=false; getgenv().Hopping=true; return end end
    end
    
    getgenv().Hopping = true; task.wait(3)
    local PlaceID = game.PlaceId; local AllIDs = {}; local actualHour = os.date("!*t").hour
    pcall(function() AllIDs = HttpService:JSONDecode(readfile("NotSameServers.json")) end)
    if not AllIDs or tonumber(AllIDs[1]) ~= actualHour then AllIDs = {actualHour} end
    table.insert(AllIDs, game.JobId); pcall(function() writefile("NotSameServers.json", HttpService:JSONEncode(AllIDs)) end)
    
    local function Scan()
        local cursor = ""; local url = 'https://games.roblox.com/v1/games/' .. PlaceID .. '/servers/Public?sortOrder=Asc&limit=100'
        while true do
            local success, result = pcall(function() return HttpService:JSONDecode(game:HttpGet(url .. (cursor ~= "" and '&cursor=' .. cursor or ""))) end)
            if success and result and result.data then
                for _, v in pairs(result.data) do
                    local ID = tostring(v.id)
                    if v.playing < (v.maxPlayers - 2) and ID ~= game.JobId then
                        local exists = false
                        for _, old in pairs(AllIDs) do if ID == tostring(old) then exists = true end end
                        if not exists then
                            table.insert(AllIDs, ID); pcall(function() writefile("NotSameServers.json", HttpService:JSONEncode(AllIDs)) end)
                            pcall(function() RunService:Set3dRenderingEnabled(false) end)
                            game:GetService("TeleportService"):TeleportToPlaceInstance(PlaceID, ID, LP); task.wait(15)
                        end
                    end
                end
                if result.nextPageCursor then cursor = result.nextPageCursor else cursor = "" end
            else
                if getgenv().Config.Disable3DRender then pcall(function() RunService:Set3dRenderingEnabled(false) end) end
                game:GetService("TeleportService"):Teleport(game.PlaceId, LP)
            end
        end
    end
    task.spawn(Scan)
end

-- [3] MAIN FARM LOOP
local function MainFarm()
    if not getgenv().Farming or getgenv().Hopping then return end
    local char = LP.Character
    local root = char and char:FindFirstChild("HumanoidRootPart")
    if not root then StatusLbl.Text = "Waiting for Character..."; return end
    
    UpdateCache()
    if getgenv().Config.FarmFruit then 
        for _, v in pairs(workspace:GetChildren()) do if v:IsA("Tool") and string.find(v.Name, "Fruit") then StatusLbl.Text = "Snipping: " .. v.Name; StoreFruit(v) end end 
    end

    local target, minDist = nil, 99999
    if getgenv().Config.FarmChests then
        for _, v in pairs(getgenv().ChestCache) do
            if v and v.Parent then
                local dist = (v.Position - root.Position).Magnitude
                if dist < getgenv().Config.MaxFarmDistance and not getgenv().VisitedChests[v] then
                    local isDup = false
                    for _, pos in pairs(getgenv().CollectedPositions) do if (v.Position - pos).Magnitude < 5 then isDup = true break end end
                    if not isDup and dist < minDist then target = v minDist = dist end
                end
            end
        end
    end

    if target then
        getgenv().IsMoving = true; StatusLbl.Text = "Chest: " .. math.floor(minDist) .. "m"
        local tween = TweenService:Create(root, TweenInfo.new(minDist/getgenv().Config.TweenSpeed, Enum.EasingStyle.Linear), {CFrame = target.CFrame})
        tween:Play()
        while tween.PlaybackState == Enum.PlaybackState.Playing do 
            if not getgenv().Farming or getgenv().Hopping then tween:Cancel() return end 
            task.wait(0.05) 
        end
        if target.Parent and (target.Position - root.Position).Magnitude < 15 then
            firetouchinterest(root, target, 0); firetouchinterest(root, target, 1)
            pcall(function() fireclickdetector(target:FindFirstChildOfClass("ClickDetector")) end)
            getgenv().VisitedChests[target] = true; table.insert(getgenv().CollectedPositions, target.Position)
            getgenv().Stats.Chests = getgenv().Stats.Chests + 1; ChestsLbl.Text = "Chests: "..getgenv().Stats.Chests
            task.wait(0.05)
        end
        getgenv().IsMoving = false
    else
        StatusLbl.Text = "Finished! Hopping..."; task.wait(3); ServerHop()
    end
end

-- [4] START LOOPS
task.spawn(function() while true do if getgenv().Farming and not getgenv().Hopping then pcall(MainFarm) end task.wait(0.1) end end)
task.spawn(function() while true do TimerLbl.Text = string.format("Time: %02d:%02d:%02d", math.floor((os.time()-getgenv().Stats.StartTime)/3600), math.floor(((os.time()-getgenv().Stats.StartTime)%3600)/60), (os.time()-getgenv().Stats.StartTime)%60) task.wait(1) end end)
task.spawn(function()
    local StartClock = os.time()
    while task.wait(5) do
        if getgenv().Hopping then continue end 
        if not getgenv().Farming then continue end
        if getgenv().Config.MaxTime and (os.time() - StartClock) >= getgenv().Config.MaxTime then ServerHop() end
    end
end)
