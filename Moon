local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local Lighting = game:GetService("Lighting")
local LP = Players.LocalPlayer

-- CONSTANTS
local FileName = "MoonDatabase_v4_Visual.json" -- New File for New Logic
local CycleDuration = 80 * 60 -- Full Cycle is approx 80 mins
local PhaseDuration = CycleDuration / 8 -- Approx 10 mins per phase
local MaxServerAge = 12 * 3600 

-- MOON DATA (Texture = Phase Number)
-- Phase 8 is FULL MOON. Phase 1 is Just after Full.
local MoonMap = {
    ["http://www.roblox.com/asset/?id=9709149431"] = 8, -- üåï Full Moon (Target)
    ["http://www.roblox.com/asset/?id=9709149052"] = 7, -- üåñ Waxing Gibbous
    ["http://www.roblox.com/asset/?id=9709143733"] = 6, -- üåó Last Quarter
    ["http://www.roblox.com/asset/?id=9709150401"] = 5, -- üåò Waning Crescent
    ["http://www.roblox.com/asset/?id=9709135895"] = 4, -- üåë New Moon (0%)
    ["http://www.roblox.com/asset/?id=9709139597"] = 3, -- üåí Waxing Crescent
    ["http://www.roblox.com/asset/?id=9709150086"] = 2, -- üåì First Quarter
    ["http://www.roblox.com/asset/?id=9709149680"] = 1, -- üåî Waning Gibbous
}

-- REVERSE LOOKUP: How many minutes until Phase 8 (Full Moon) from current Phase?
-- Example: If Phase 7, we wait 1 Phase duration. If Phase 4, we wait 4.
local function GetMinutesUntilFull(phaseNum)
    if phaseNum == 8 then return 0 end -- It's active!
    
    -- Math: How many jumps to get to 8?
    -- Phases go 1 -> 2 -> ... -> 8.
    local jumpsNeeded = 8 - phaseNum
    return jumpsNeeded * (PhaseDuration / 60) -- Returns minutes
end

print("\n\n")
print("========================================")
print("üåë MOON DATABASE: VISUAL ANCHOR SYSTEM")

-- 1. DATABASE MANAGER
local function LoadData()
    if isfile(FileName) then
        local content = readfile(FileName)
        if content == "" or content == "[]" then return {} end
        local success, result = pcall(function() return HttpService:JSONDecode(content) end)
        if success and type(result) == "table" then return result else return {} end
    end
    return {}
end

local function SaveData(data)
    writefile(FileName, HttpService:JSONEncode(data))
end

-- 2. "VISUAL ANCHOR" SAVE
local db = LoadData()
local currentJob = game.JobId
local isPrivate = (game.PrivateServerId ~= "" and game.PrivateServerOwnerId ~= 0)

if isPrivate then
    warn("‚ö†Ô∏è PRIVATE SERVER. NOT SAVING.")
else
    if game.PlaceId > 0 and currentJob ~= "" then
        
        -- A. READ VISUALS
        local currentTex = Lighting.Sky.MoonTextureId
        local visualPhase = MoonMap[currentTex] or 0 -- 0 means Unknown
        
        -- B. CALCULATE ANCHOR POINT
        -- Instead of saving "Server Start Time", we save "When we saw this Phase".
        if visualPhase > 0 then
            db[currentJob] = {
                jobId = currentJob,
                placeId = game.PlaceId,
                
                -- THE ANCHOR:
                seenTime = os.time(),      -- "I saw the moon at this real world time..."
                seenPhase = visualPhase,   -- "...and it was Phase X."
                
                visualCheck = true         -- Mark as "Visually Verified"
            }
            print("‚úÖ VISUAL ANCHOR SAVED: Phase " .. visualPhase .. "/8")
        else
            -- Fallback: If sky texture is empty (Glitch/Day?), keep old data if exists
            if not db[currentJob] then
                print("‚ö†Ô∏è No Moon Texture found (Daytime?). Saving partial data.")
                db[currentJob] = {
                    jobId = currentJob,
                    placeId = game.PlaceId,
                    seenTime = os.time(),
                    seenPhase = 0, -- Needs update later
                    visualCheck = false
                }
            end
        end
    end
end

-- 3. CLEANUP
local deleted = 0
for id, info in pairs(db) do
    local age = os.time() - info.seenTime
    if age > MaxServerAge then 
        db[id] = nil 
        deleted = deleted + 1
    end
end
SaveData(db)

-- 4. PREDICT & RANK
local candidates = {}
local scannedCount = 0

for id, info in pairs(db) do
    scannedCount = scannedCount + 1
    
    local timePassed = os.time() - info.seenTime -- Seconds since we last saw it
    local timePassedMins = timePassed / 60
    
    -- PREDICTION LOGIC
    local predictedMinsLeft = 999
    
    if info.seenPhase > 0 then
        -- We have visual data!
        -- 1. Calculate how many minutes were left when we SAW it.
        local initialWait = GetMinutesUntilFull(info.seenPhase)
        
        -- 2. Subtract time passed since then.
        local currentWait = initialWait - timePassedMins
        
        -- 3. Handle cycles (If we waited past the full moon, when is the NEXT one?)
        while currentWait < -5 do -- Allow 5 min active window
            currentWait = currentWait + 80 -- Add full cycle (80 mins)
        end
        
        predictedMinsLeft = currentWait
    else
        -- No visual data (Phase 0). We can't predict accurately.
        predictedMinsLeft = 9999
    end
    
    -- Format Age
    local ageH = math.floor(timePassed / 3600)
    local ageM = math.floor((timePassed % 3600) / 60)
    
    if predictedMinsLeft < 900 then -- Only valid predictions
        table.insert(candidates, {
            jobId = info.jobId,
            placeId = info.placeId,
            waitMins = math.floor(predictedMinsLeft),
            waitSecs = math.floor(predictedMinsLeft * 60),
            ageText = ageH .. "h " .. ageM .. "m",
            phase = info.seenPhase
        })
    end
end

table.sort(candidates, function(a, b) return a.waitSecs < b.waitSecs end)

-- 5. OUTPUT
print("üìä Servers Tracked: " .. scannedCount)
print("----------------------------------------")
print("üìç CURRENT ID: " .. currentJob)
print("----------------------------------------")

if #candidates > 0 then
    print("üèÜ TOP 2 VISUAL PREDICTIONS:")
    
    for i = 1, math.min(2, #candidates) do
        local c = candidates[i]
        local isCurrent = (c.jobId == currentJob)
        
        print("\nOPTION #" .. i .. (isCurrent and " (HERE)" or ""))
        
        if c.waitSecs <= 0 then
            warn("üåï STATUS: MOON SHOULD BE ACTIVE!")
            print("‚è≥ Prediction: Started " .. math.abs(c.waitMins) .. " mins ago.")
        else
            print("‚è∞ Full Moon In: ~" .. c.waitMins .. " mins")
        end
        
        print("üëÅÔ∏è Based on Visual: Phase " .. c.phase .. "/8")
        print("‚è≥ Data Age: " .. c.ageText .. " ago")
        print("üÜî ID: " .. c.jobId)
        
        if not isCurrent then
            -- SMART DELETE SCRIPT
            local smartJoinScript = string.format([[
local TP = game:GetService("TeleportService")
local HS = game:GetService("HttpService")
local ID = "%s"
local FILE = "%s"
local P = game.Players.LocalPlayer
TP:TeleportToPlaceInstance(%d, ID, P)
local conn
conn = TP.TeleportInitFailed:Connect(function(plr, result, msg)
    if plr == P then
        warn("‚ùå JOIN FAILED")
        if result == Enum.TeleportResult.GameFull or result == Enum.TeleportResult.GameNotFound then
            if isfile(FILE) then
                local raw = readfile(FILE)
                local db = HS:JSONDecode(raw)
                if db[ID] then
                    db[ID] = nil
                    writefile(FILE, HS:JSONEncode(db))
                    warn("üóëÔ∏è DELETED BAD SERVER")
                end
            end
        end
        conn:Disconnect()
    end
end)
]], c.jobId, FileName, c.placeId)

            if i == 1 and setclipboard then setclipboard(smartJoinScript) end
            if i == 2 then print(smartJoinScript) end
        end
    end
else
    print("‚ùå No visual data yet. Hop servers to scan textures!")
end
print("========================================")
print("\n")local FILE = "%s"
local P = game.Players.LocalPlayer
TP:TeleportToPlaceInstance(%d, ID, P)
local conn
conn = TP.TeleportInitFailed:Connect(function(plr, result, msg)
    if plr == P then
        warn("‚ùå JOIN FAILED: " .. tostring(result))
        if result == Enum.TeleportResult.GameFull or result == Enum.TeleportResult.GameNotFound then
            warn("üóëÔ∏è AUTO-DELETING BAD SERVER...")
            if isfile(FILE) then
                local raw = readfile(FILE)
                local db = HS:JSONDecode(raw)
                if db[ID] then
                    db[ID] = nil
                    writefile(FILE, HS:JSONEncode(db))
                    warn("‚úÖ DELETED! Re-run main script.")
                end
            end
        end
        conn:Disconnect()
    end
end)
]], c.jobId, FileName, c.placeId)

            if i == 1 and setclipboard then
                setclipboard(smartJoinScript)
                warn("‚úÖ SMART SCRIPT COPIED TO CLIPBOARD!")
                if c.waitSecs <= 0 then
                    warn("üöÄ GO BACK NOW! IT IS ACTIVE!")
                end
            elseif i == 2 then
                warn("‚¨áÔ∏è Copy Option #2 manually:")
            end
            
            if i == 2 then print(smartJoinScript) end
        else
            warn("‚úÖ STAY HERE. BEST OPTION.")
        end
    end
else
    print("‚ùå No upcoming moons found. Hop to build database!")
end
print("========================================")
print("\n")
